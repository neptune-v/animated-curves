<!DOCTYPE html>
<html lang="en" ontouchmove>
<head>
    <meta charset="UTF-8">
    <title>Visualizing Elliptic Curves</title>
    <script type="module" src="page.js"></script>
    <link href="site.css" rel="stylesheet">
    <!-- xxx todo grab only what we need -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
          integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
          rel="stylesheet" crossorigin="anonymous">
</head>
<body>
<div class="container">
<h2>Consider the curve</h2>
<div>
<p>
    Every TLS 1.3 session starts with a key exchange
    made via an elliptic curve. The most popular curve is
    Curve25519, and the exchange involves adding a "base point"
    <span class="math">P</span> to
    itself over and over again:
</p>
<figure class="illustration">
<div class="ill-content">
<div>
    <canvas id="canvas-curve25519" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Fig. 1: Curve25519 point multiplication</figcaption>
</figure>
<p>
    We're looking at the heart of TLS 1.3 key exchange,
    but what's going on? Let's break it down into simple parts.
</p>
</div>

<h2>Concept 1: Adding points</h2>
<p>
    The elliptic curves we're going to start with are in this form: <span class="math">y<sup>2</sup> = x<sup>3</sup> + Ax + B</span>
<br>

<div>
<figure class="illustration">
<div class="ill-content">
<div>
<canvas id="canvas-ec-sample" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Fig. 2: Examples of elliptic curves</figcaption>
</figure>

<p>
    Let's define <strong>point addition</strong>: a way to combine two points on an elliptic
    curve to yield a third point (also on the curve).
<figure>
    <figcaption>Point addition:</figcaption>
    <ul>
    <li>draw a line between the two points
    (or if you're adding a point to itself, make a line tangent to the curve at that
    point),</li>
    <li>find where that line intersects the curve,</li>
    <li>and finally find the point opposite the x-axis from that intersection.</li>
    </ul>
</figure>
<p>Let's also introduce this shorthand for adding a point to itself multiple times (also called
    <strong>scalar multiplication</strong>):
<ul class="no-bullet">
    <li><span class="math">P+P = 2P</span></li>
    <li><span class="math">P+P+P = 3P</span></li>
    <li><span class="math">P+P+P+P = 4P</span></li>
    <li>... and so on.</li>
</ul>
<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-add" class="animated" height="400" width="500"></canvas>
</div>
    <figcaption>Fig. 3: Repeated addition of a point P</figcaption>
</figure>

<p>
    Point addition has two useful properties which we'll need later:
<ul>
    <li><strong>commutative</strong>: adding points in any order gives the same result:
        <div class="text-center"><span class="math">P + Q = Q + P</span></div></li>
    <li><strong>associative</strong>: any grouping of addition gives the same result:
        <div class="text-center"><span class="math">P+P+P+P+P = (P+P+P)+(P+P) = 3P+2P = 5P</span></div>
        <div class="text-center"><span class="math">P+P+P+P+P = (P)+(P+P+P+P) = 1P+4P = 5P</span></div>
    </li>
</ul>
<p>See the figure below, which adds points together in random order.
    The result is always the expected number.</p>

<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-assoc" class="animated" width="500" height="400"></canvas>
</div>
    <figcaption>Fig. 4: Point addition is associative and commutative</figcaption>
</figure>
</div>

<h2>Concept 2: Finite field math</h2>
<div>
<p>Next let's introduce a new set of math operations, the operations of the finite field
    <span class="fat-fp">Fp</span>.

<p>In this section we'll use the finite field with order <span class="math">p = 23</span>.
    That means that all operations will be done with the numbers 0 through 22 (one less than the prime number 23):
<div class="math text-center pb1">
<span class="fat-fp-23">F23</span> = { 0, 1, 2, 3, ..., 20, 21, 22 }
</div>

<h4>Addition and subtraction</h4>
<p>
Adding and subtracting in finite fields is pretty simple. Values of 23 and over will "wrap around" to zero, and values less
than zero will wrap around to 22:
<canvas class="numline animated" id="canvas-field-add-sub" width="500" height="80"></canvas>

<p>You might also know this as "modulo 23", or as the remainder after dividing a number by 23.

<h4>Multiplication</h4>
<p>
Multiplication is also straightforward. Similar to addition, the result is taken modulo 23:

<canvas class="numline animated" id="canvas-field-mult" width="500" height="80"></canvas>

<h4>Division (multiplicative inverse)</h4>
<p>
The operation that we'll use for division is where things become interesting. Let's start by thinking of division by
    <span class="math">n</span> in terms of this equation:
<div class="text-center">
<div class=math>n / n = 1</div>
Or if we expand some terms:
<div class=math>n &times; (1/n) = 1</div>
Let's use a slightly different notation for <span class="math">1/n</span> which is easier to fit on a line:
<div class=math>n &times; n<sup>-1</sup> = 1</div>
</div>
<p>
    In those terms, we can imagine that dividing by <span class="math">n</span> is the same as multiplying
    by whatever number <span class="math">n<sup>-1</sup></span> multiplied by <span class="math">n</span> equals 1.
    In the finite field multiplication that we've defined above, this is a positive integer number.
    There's exactly one solution to this problem for each non-zero integer in <span class="fat-fp">Fp</span>:
<canvas class="numline animated" id="canvas-field-div" width="500" height="80"></canvas>

<p>
The inverse for each number in <span class="fat-fp-23">F23</span> is provided <a target="_blank" href="inverse23.html">in a table</a>.

<h4>Square root</h4>
<p>
    Our last operation to define is taking a square root.
    Similar to division, we'll define the square root as a number in <span class="fat-fp">Fp</span>
    which satisfies this equation:
<div class="math text-center">
    sqrt(n) &times; sqrt(n) = n
</div>
<canvas class="numline animated" id="canvas-field-sqrt" width="500" height="80"></canvas>
<p>
In real numbers, there are two solutions to this problem (positive and negative).
Similarly in <span class="fat-fp">Fp</span> there are two solutions
(which when added together equal zero in <span class="fat-fp">Fp</span>).

<p>
The square roots for each number in <span class="fat-fp-23">F23</span> is provided <a target="_blank" href="sqrt23.html">in a table</a>.
</div>

<h2>Concept 3: Elliptic curves <em>plus</em> finite fields</h2>
<div>
<p>
Now we can combine the two concepts of elliptic curves and finite field math.
<p>
Let's start with an elliptic curve equation:
<div class="text-center math pb1">
y<sup>2</sup> = x<sup>3</sup> + 38x<sup>2</sup> + x
</div>
<p>For our finite field choose a small prime integer, <span class="math">p = 61</span>:
<div class="text-center math pb1">
<span class="fat-fp-61">F61</span> = { 0, 1, 2, ... 59, 60 }
</div>
<p>
We'll also pre-compute the tables for <a href="inverse61.html">division</a> and <a href="sqrt61.html">square roots</a>
in <span class="fat-fp-61">F61</span>.

<p>
What would it look like to plot this elliptic curve on a graph?
Starting with <span class="math">x = 0</span>,
and working through each number in <span class="fat-fp-61">F61</span>:

<table class="table table-sm table-borderless math ml2">
    <tbody>
    <tr>
        <td>x = 0:</td>
        <td>y<sup>2</sup> = 0<sup>3</sup> + 38&middot;0<sup>2</sup> + 0;</td>
        <td>y<sup>2</sup> = 0;</td>
        <td>y is 0</td>
    </tr>
    <tr>
        <td>x = 1:</td>
        <td>y<sup>2</sup> = 1<sup>3</sup> + 38&middot;1<sup>2</sup> + 1;</td>
        <td>y<sup>2</sup> = 40;</td>
        <td>y is not defined</td>
    </tr>
    <tr>
        <td>x = 2:</td>
        <td>y<sup>2</sup> = 2<sup>3</sup> + 38&middot;2<sup>2</sup> + 2;</td>
        <td>y<sup>2</sup> = 162 % 61 = 40;</td>
        <td>y is not defined</td>
    </tr>
    <tr>
        <td>x = 3:</td>
        <td>y<sup>2</sup> = 3<sup>3</sup> + 38&middot;3<sup>2</sup> + 3;</td>
        <td>y<sup>2</sup> = 372 % 61 = 6;</td>
        <td>y is not defined</td>
    </tr>
    <tr>
        <td>x = 4:</td>
        <td>y<sup>2</sup> = 4<sup>3</sup> + 38&middot;4<sup>2</sup> + 4;</td>
        <td>y<sup>2</sup> = 676 % 61 = 5;</td>
        <td>y is 26 and 35</td>
    </tr>
    <tr>
        <td colspan=4>... and so on ...</td>
    </tr>
    </tbody>
</table>

<p>
The result is this:
<figure class="illustration">
    <div class="ill-content">
    <canvas id="canvas-curve61-static" width="500" height="400"></canvas>
    </div>
    <figcaption>Fig. 5: An elliptic curve plotted in <span class="fat-fp-61">Fp</span></figcaption>
</figure>

</div>

<h2>A toy curve</h2>
<p>
    The curve Curve25519 is <em>huge</em>. Numbers range from <span class="math">0</span>
    to <span class="math">2<sup>255</sup>-19</span>. That's a 77-digit number!
    Let's make a smaller curve that's easier to talk about.
</p>
<p>
    Our smaller curve (let's call it "Curve61") ranges from 0 to 61,
    and the curve equation will be:
    <span class="math center-block">
    y<sup>2</sup> = x<sup>3</sup> + 38x<sup>2</sup> + x
    </span>
</p>
<figure class="illustration">
<div class="ill-content">
<div>
    <canvas class="animated" id="canvas-addp" width="500" height="400"></canvas>
</div>
<span>Base point <span class="point-p">P</span> is:
    <span class="x-point-p">(7, 4)</span></span>
<br>
<span id="np-desc">
    Point <span class="point-np"><span id="n">1</span>P</span> is:
    <span id="np" class="x-point-np">(7, 4)</span>
</span>
</div>
    <figcaption>Curve61 point addition</figcaption>
</figure>

</div> <!-- container -->

<script>
    let fs = document.getElementsByClassName('fat-fp')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>p</sub></span>';
    }
    fs = document.getElementsByClassName('fat-fp-23')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>23</sub></span>';
    }
    fs = document.getElementsByClassName('fat-fp-61')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>61</sub></span>';
    }
</script>
</body>
</html>
