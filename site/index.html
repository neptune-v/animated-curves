<!DOCTYPE html>
<html lang="en" ontouchmove>
<head>
    <meta charset="UTF-8">
    <title>Visualizing Elliptic Curves</title>
    <script type="module" src="page.js"></script>
    <link href="site.css" rel="stylesheet">
    <!-- xxx todo grab only what we need -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
          integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
          rel="stylesheet" crossorigin="anonymous">
</head>
<body class="main-page">
<div class="container">
<h2>Consider the curve</h2>
<div>
<p>
    Every TLS 1.3 session starts with a key exchange
    made via an elliptic curve. The most popular curve is
    Curve25519, and the exchange involves adding a "base point"
    <span class="math">P</span> to
    itself over and over again:
</p>
<figure class="illustration">
<div class="ill-content">
<div>
    <canvas id="canvas-curve25519" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Curve25519 point multiplication</figcaption>
</figure>
<p>
    We're looking at the heart of TLS 1.3 key exchange,
    but what's going on? Let's break it down into simple parts.
</p>
</div>

<h2>Concept 1: Adding points on a curve</h2>
<p>
    The elliptic curves we're going to start with are in this form: <span class="math">y<sup>2</sup> = x<sup>3</sup> + Ax + B</span>
<br>

<div>
<figure class="illustration">
<div class="ill-content">
<div>
<canvas id="canvas-ec-sample" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Examples of elliptic curves</figcaption>
</figure>

<p>
    Let's define <strong>point addition</strong>: a way to combine two points on an elliptic
    curve to yield a third point (also on the curve).
<figure>
    <figcaption>Point addition:</figcaption>
    <ol>
    <li>draw a line between the two points
    (or if you're adding a point to itself, make a line tangent to the curve at that
    point),</li>
    <li>find where that line intersects the curve,</li>
    <li>and finally negate the y-value of that point (flip it from positive to negative or vice versa).</li>
    </ol>
</figure>
<p>Let's also introduce a shorthand for adding a point to itself multiple times (also called
    <strong>scalar multiplication</strong>):
<ul class="no-bullet">
    <li><span class="math">P+P = 2P</span></li>
    <li><span class="math">P+P+P = 3P</span></li>
    <li><span class="math">P+P+P+P = 4P</span></li>
    <li>... and so on.</li>
</ul>
<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-add" class="animated" height="400" width="500"></canvas>
</div>
    <figcaption>Repeated addition of a point P</figcaption>
</figure>

<p>
    Point addition has two useful properties which we'll need later:
<ul>
    <li><strong>commutative</strong>: adding points in any order gives the same result:
        <div class="text-center"><span class="math">P + Q + R = R + Q + P = Q + R + P</span></div></li>
    <li><strong>associative</strong>: any grouping of addition gives the same result:
        <div class="text-center"><span class="math">P+P+P+P+P = (P+P+P)+(P+P) = 3P+2P = 5P</span></div>
        <div class="text-center"><span class="math">P+P+P+P+P = (P)+(P+P+P+P) = 1P+4P = 5P</span></div>
    </li>
</ul>
<p>See the animation below, which adds points together in random order.
    The result is always the expected number.</p>

<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-assoc" class="animated" width="500" height="400"></canvas>
</div>
    <figcaption>Point addition is associative and commutative</figcaption>
</figure>
</div>

<h2>Concept 2: Finite field math</h2>
<div>
<p>Next let's put the curves aside and introduce a new set of math operations,
    the operations of the finite field <span class="fat-fp">Fp</span>.

<p>A finite field is just a list of numbers. In this section we'll set <span class="math">p = 23</span>
    (a prime number). The finite field <span class="fat-fp-23">F23</span> is the list
    of numbers 0 through 22:
<div class="math text-center pb1">
<span class="fat-fp-23">F23</span> = { 0, 1, 2, 3, ..., 20, 21, 22 }
</div>

<p>
All the math operations below use only those 23 numbers as inputs as outputs. No negative numbers,
    no floating point, and nothing higher than 22.

<h4>Addition and subtraction</h4>
<p>
Adding and subtracting in finite fields is pretty simple. Values of 23 and over will "wrap around" to zero, and values less
than zero will wrap around to 22:
<canvas class="numline animated" id="canvas-field-add-sub" width="500" height="80"></canvas>

<p>You might also know this as "modulo 23", or as the remainder after dividing a number by 23.

<h4>Multiplication</h4>
<p>
Multiplication is also straightforward. Similar to addition, the result is taken modulo 23:

<canvas class="numline animated" id="canvas-field-mult" width="500" height="80"></canvas>

<h4>Negation</h4>
<p>
Negating a value in real numbers means flipping it from positive to negative (or vice versa). Another
    definition could be finding the value <span class="math">n</span> for <span class="math">p</span>
    that satisfies this equation:
<div class="math text-center pb1">
p + n = 0
</div>

<p>
Using our rules for addition above, we can work out that negating a number
    in <span class="fat-fp">Fp</span> means subtracting that number from <span class="math">p</span>:
<div class="math text-center pb1">
1 + 22 = 0; 1 negated is 22
<br>
2 + 21 = 0; 2 negated is 21
<br>
3 + 20 = 0; 3 negated is 20
<br>
...
<br>
22 + 1 = 0; 22 negated is 1
</div>

<canvas class="numline animated" id="canvas-field-negate" width="500" height="80"></canvas>

<h4>Division (multiplicative inverse)</h4>
<p>
Division is where things become interesting. Let's start by noting
    that any non-zero number <span class="math">n</span> divided by itself is 1:
<div class="text-center">
<div class=math>n / n = 1</div>
Or if we expand some terms:
<div class=math>n &times; (1/n) = 1</div>
Let's use a slightly different notation for <span class="math">1/n</span> which is easier to fit on a line:
<div class=math>n &times; n<sup>-1</sup> = 1</div>
</div>
<p>
    Based on the above, you can see that dividing by <span class="math">n</span> is the same as multiplying
    by the term <span class="math">n<sup>-1</sup></span>.
<p>
    In the description of multiplication above, you can see how it's possible for two
    positive integers to equal 1 when multiplied together.
    It turns out that for each positive integer in <span class="fat-fp">Fp</span> there is one
    positive integer that acts as this "multiplicative inverse":
<canvas class="numline animated" id="canvas-field-div" width="500" height="80"></canvas>

<p>
To tie it all together, when working in <span class="fat-fp">Fp</span> any time we need to divide by a number
    <span class="math">n</span> we will instead multiply by its multiplicative inverse <span class="math">n<sup>-1</sup></span>,
    the number which satisfies the equation <span class="math">n &times; n<sup>-1</sup> = 1</span>.

<p>
    The inverse for each number in
    <span class="fat-fp-23">F23</span> is provided <a target="_blank" href="inverse23.html">in this table</a>.

<h4>Square root</h4>
<p>
    Our last operation to define is taking a square root.
    We'll define the square root of <span class="math">n</span>
    as a number in <span class="fat-fp">Fp</span>
    which satisfies this equation:
<div class="math text-center pb1">
    sqrt(n) &times; sqrt(n) = n
</div>
<p>
In real numbers there are two solutions to this problem for non-zero numbers (positive and negative).
Non-zero numbers in <span class="fat-fp">Fp</span> also have two solutions.

    <canvas class="numline animated" id="canvas-field-sqrt" width="500" height="80"></canvas>

<p>
    Only half of the non-zero members of <span class="fat-fp">Fp</span> have square roots.
    The square roots in <span class="fat-fp-23">F23</span> are
    provided <a target="_blank" href="sqrt23.html">in this table</a>.
</div>

<h2>Concept 3: Elliptic curves <em>plus</em> finite fields</h2>
<div>
<p>
Now we can combine the two concepts of elliptic curves and finite field math.
<p>
Let's start with an elliptic curve equation:
<div class="text-center math pb1">
y<sup>2</sup> = x<sup>3</sup> + 9x + 1
</div>
<p>For our finite field we choose a small prime integer, <span class="math">p = 61</span>:
<div class="text-center math pb1">
<span class="fat-fp-61">F61</span> = { 0, 1, 2, ... 59, 60 }
</div>
<p>
We'll also pre-compute the tables for <a href="inverse61.html">division</a> and <a href="sqrt61.html">square roots</a>
in <span class="fat-fp-61">F61</span>.

<p>
What would it look like to plot this elliptic curve on a graph?
Starting with <span class="math">x = 0</span>,
and working through each number from 0 to 60, and using the math operations defined for
    <span class="fat-fp-61">F61</span>:

<table class="table table-sm table-borderless math ml2">
    <tbody>
    <tr>
        <td>x = 0:</td>
        <td>y<sup>2</sup> = 0<sup>3</sup> + 9&middot;0 + 1;</td>
        <td>y<sup>2</sup> = 1 % 61 = 1;</td>
        <td>y = sqrt(1) = 1 and 60</td>
    </tr>
    <tr>
        <td>x = 1:</td>
        <td>y<sup>2</sup> = 1<sup>3</sup> + 9&middot;1 + 1;</td>
        <td>y<sup>2</sup> = 11 % 61 = 11;</td>
        <td>y = sqrt(11) = undefined</td>
    </tr>
    <tr>
        <td>x = 2:</td>
        <td>y<sup>2</sup> = 2<sup>3</sup> + 9&middot;2 + 1;</td>
        <td>y<sup>2</sup> = 27 % 61 = 27;</td>
        <td>y = sqrt(27) = 24 and 37</td>
    </tr>
    <tr>
        <td>x = 3:</td>
        <td>y<sup>2</sup> = 3<sup>3</sup> + 9&middot;3 + 1;</td>
        <td>y<sup>2</sup> = 55 % 61 = 55;</td>
        <td>y = sqrt(55) = not defined</td>
    </tr>
    <tr>
        <td>x = 4:</td>
        <td>y<sup>2</sup> = 4<sup>3</sup> + 9&middot;4 + 1;</td>
        <td>y<sup>2</sup> = 101 % 61 = 40;</td>
        <td>y = sqrt(40) = not defined</td>
    </tr>
    <tr>
        <td>x = 5:</td>
        <td>y<sup>2</sup> = 5<sup>3</sup> + 9&middot;5 + 1;</td>
        <td>y<sup>2</sup> = 171 % 61 = 49;</td>
        <td>y = sqrt(49) = 7 and 54</td>
    </tr>
    <tr>
        <td colspan=4>... and so on ...</td>
    </tr>
    </tbody>
</table>

<p>
The resulting graph is this:
<figure class="illustration">
    <div class="ill-content">
    <canvas id="canvas-curve61-static" width="500" height="400"></canvas>
    </div>
    <figcaption>An elliptic curve plotted in <span class="fat-fp-61">Fp</span></figcaption>
</figure>

<p>
We can add points on this curve, using the math of <span class="fat-fp-61">F61</span> and
the rules of point addition (draw lines between two points, find the curve intersection, negate the point):

<figure class="illustration">
<div class="ill-content">
    <canvas class="animated" id="canvas-addp" width="500" height="400"></canvas>
</div>
    <figcaption>Curve61 point addition</figcaption>
</figure>

<p>The animation above shows lines wrapping between 61 and 0 (the modulus effect shown visually),
    sometimes many times. The actual math of finding the intersecting curve points is relatively
    straightforward, though:
<p>
    To double a point P (x_1, y_1) to get 2P (x_3, y_3):
<div class="math text-center">
&lambda; = (3x_1^2 + 9) / (2y_1)
<br>
x_3 = &lambda;^2 - x_1 - x_1
<br>
y_3 = &lambda;(x_1 - x_3) - y_1
</div>
<p>
    To add two points P (x_1, y_1) and Q (x_2, y_2) to get R (x_3, y_3):
<div class="math text-center">
&lambda; = (y_2 - y_1) / (x_2 - x_1)
<br>
x_3 = &lambda;^2 - x_1 - x_1
<br>
y_3 = &lambda;(x_1 - x_3) - y_1
</div>
</div>

</div> <!-- container -->

<script>
    let fs = document.getElementsByClassName('fat-fp')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>p</sub></span>';
    }
    fs = document.getElementsByClassName('fat-fp-23')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>23</sub></span>';
    }
    fs = document.getElementsByClassName('fat-fp-61')
    for (let f of fs) {
        f.innerHTML = '<span class="math">&#x1D53D;<sub>61</sub></span>';
    }
</script>
</body>
</html>
