<!DOCTYPE html>
<html lang="en" ontouchmove>
<head>
    <title>Visualizing Elliptic Curves</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="title" content="Visualizing Elliptic Curves"/>
    <meta name="description" content="Learn elliptic curve cryptography via animated examples on a toy curve"/>

    <link href="site.css" rel="stylesheet">
    <!-- xxx todo grab only what we need -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
          integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
          rel="stylesheet" crossorigin="anonymous">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://curves.ulfheim.net/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Visualizing Elliptic Curves">
    <meta property="og:description" content="Learn elliptic curve cryptography via animated examples on a toy curve">
    <meta property="og:image" content="https://curves.ulfheim.net/og.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="curves.ulfheim.net">
    <meta property="twitter:url" content="https://curves.ulfheim.net/">
    <meta name="twitter:title" content="Visualizing Elliptic Curves">
    <meta name="twitter:description" content="Learn elliptic curve cryptography via animated examples on a toy curve">
    <meta name="twitter:image" content="https://curves.ulfheim.net/og.png">

    <!-- favicons -->
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <script type="module" src="page.js" async></script>
    <script>
        MathJax = {
            loader: {load: ['input/asciimath', 'output/chtml']},
            chtml: { scale: 0.9 }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js">
    </script>
</head>
<body class="main-page">
<div class="container">
<p>
ðŸ‘‹ Hi there!  This is a work in progress.  Feel free to look around but please don't share or publish
    this page yet. This page might be broken at times, and I promise the complete page will
    be better anyway.
<h1>Visualizing Elliptic Curve Cryptography</h1>
<div>
<p>
    Every TLS 1.3 session starts with a key exchange
    made via an elliptic curve. The most popular curve is
    Curve25519, and the exchange involves adding a "base point"
    <span class="mathy">P</span>
    to itself over and over again:
</p>
<figure class="illustration">
<div class="ill-content">
<div>
    <canvas id="canvas-curve25519" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Curve25519 point addition</figcaption>
</figure>
<p>
    We're looking at the heart of TLS 1.3 key exchange,
    but what's going on? Let's break it down into simple parts.
</p>
</div>

<h2>Adding points on a curve</h2>
<p>
    The elliptic curves we're going to use are in this form:
    `y^2 = x^3 + Ax + B`
<br>

<div>
<figure class="illustration">
<div class="ill-content">
<div>
<canvas id="canvas-ec-sample" class="animated" width="500" height="300"></canvas>
</div>
</div>
    <figcaption>Examples of elliptic curves</figcaption>
</figure>

<p>
    Let's define <strong>point addition</strong>: a way to combine two points on an elliptic
    curve to yield a third point (also on the curve).
<div class="skinny-block">
    <strong>Point addition:</strong>
    <ul>
    <li>draw a line between the two points
    (or if you're adding a point to itself, make a line tangent to the curve at that
    point),</li>
    <li>find where that line intersects the curve,</li>
    <li>and finally negate the y-value of that point (flip it from positive to negative or vice versa).</li>
    </ul>
</div>

<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-add" class="animated" height="400" width="500"></canvas>
</div>
    <figcaption>Repeated addition of a point P</figcaption>
</figure>

<p>
    Point addition has two useful properties which we'll need later:
<ul class="skinny-block">
    <li><strong>commutative</strong>: adding points in any order results in the same point:
        <div class="text-center mathy phalf">
        P+Q+R = R+Q+P = P+R+Q
        </div>
    <li><strong>associative</strong>: adding the results of additions results in the same point:
        <div class="text-center mathy phalf">
        P+P+P+P+P = (P+P) + (P+P+P) = 2P + 3P = 5P
        <br>
        P+P+P+P+P = (P+P+P+P) + (P) = 4P + 1P = 5P
        </div>
    </li>
</ul>
<p>See the animation below which adds points in random order.
    The result is always the expected point.</p>

<figure class="illustration">
<div class="ill-content">
<canvas id="canvas-real-assoc" class="animated" width="500" height="400"></canvas>
</div>
    <figcaption>Point addition is associative and commutative</figcaption>
</figure>
</div>

<h2>Finite field math</h2>
<div>
<p>Next let's put curves aside and introduce a new set of math operations,
    the operations of the finite field <span class="fat-fp">Fp</span>.

<p>A finite field is just a set of numbers. In this section we'll set
    `p` to 23 (a prime number). The finite field <span class="fat-fp-23">F23</span> is the list
    of numbers 0 through 22:
    <div class="math-block">
        `\mathbb{F}_23 = {0, 1, 2, â€¦, 22}`
    </div>

<p>
All the math operations below use only those 23 numbers as inputs as outputs. No negative numbers,
    no floating point, and nothing higher than 22.

<h4>Addition / Subtraction</h4>
<p>
Adding and subtracting in finite fields is pretty simple. Values of 23 and greater will wrap around to
zero, and values below zero will wrap around to 22:
<canvas class="numline animated" id="canvas-field-add-sub" width="500" height="80"></canvas>

<p>You might also know this as "modulo 23", or as the remainder after dividing a number by 23.

<h4>Multiplication</h4>
<p>
Multiplication is also straightforward. Similar to addition, the result is taken modulo 23:

<canvas class="numline animated" id="canvas-field-mult" width="500" height="80"></canvas>

<h4>Negation</h4>
<p>
You might be used to negation as flipping a value's sign from positive to negative
    (or vice versa). Another definition would be finding the value
    `\text{-}n` for `n` that satisfies this equation:
    <div class="math-block">
    `n + \text{-}n = 0`
    </div>

<p>
    In <span class="fat-fp">Fp</span>, we can solve the above and negate a number by subtracting
    it from `p`:

<canvas class="numline animated" id="canvas-field-negate" width="500" height="80"></canvas>

<h4>Division (multiplicative inverse)</h4>
<p>
In field math division is defined by the idea
    that any non-zero number divided by itself is 1:
    <div class="math-block">
    `\frac{n}{n} = 1`
    </div>
<p>Or if we expand some terms:
    <div class="math-block">
    `n \cdot \frac{1}{n} = 1`
    </div>
<p>Let's use a different notation for `1//n` which is easier to fit on a line:
    <div class="math-block">
    `n \cdot n^(\text{-}1) = 1`
    </div>

<p>
    You can see that dividing by `n` is the same as multiplying by the value `n^(\text{-}1)`.

<p>
    In our <span class="fat-fp">Fp</span> multiplication it's possible for two
    positive integers to equal 1 when multiplied together.
    It turns out that for each positive integer in <span class="fat-fp">Fp</span> there is one
    positive integer that acts as this "multiplicative inverse":
<canvas class="numline animated" id="canvas-field-div" width="500" height="80"></canvas>

<p>
To tie it all together, when working in <span class="fat-fp">Fp</span>
    any time we need to divide by a number `n` we will instead
    multiply by its multiplicative inverse `n^(\text{-}1)`,
    the number which satisfies the equation `n \cdot n^(\text{-}1) = 1`.

<p>
    The inverse for each number in
    <span class="fat-fp-23">F23</span> is provided <a target="_blank" href="inverse23.html">in this table</a>.

<h4>Square root</h4>
<p>
    Our last operation to define is taking a square root.
    We'll define the square root of `n`
    as a number in <span class="fat-fp">Fp</span>
    which satisfies this equation:

    <div class="math-block">
    `sqrt(n) \times sqrt(n) = n`
    </div>
<p>
In real numbers there are generally two solutions to this problem (positive and negative).
In a similar way there are two square root solutions to non-zero numbers in <span class="fat-fp">Fp</span>.

    <canvas class="numline animated" id="canvas-field-sqrt" width="500" height="80"></canvas>

<p>
    Only half of the non-zero members of <span class="fat-fp">Fp</span> have square roots.
    The square roots in <span class="fat-fp-23">F23</span> are
    provided <a target="_blank" href="sqrt23.html">in this table</a>.
</div>

<h2>Elliptic curves <em>and</em> finite fields</h2>
<div>
<p>
Now we can combine the two concepts of elliptic curves and finite field math.
Let's start with an elliptic curve equation:
    <div class="math-block">
    `y^2 = x^3 + 9x + 1`
    </div>

<p>For our finite field let's use the prime number 61:

    <div class="math-block">
    `\mathbb{F}_61 = {0, 1, 2, â€¦, 60}`
    </div>


<p>
    The tables for <a href="inverse61.html">division</a>
    and <a href="sqrt61.html">square roots</a>
    in <span class="fat-fp-61">F61</span> are pre-computed for convenience.

<p>
    Lastly, we'll nominate one of the points on this curve to be the "base point":
    <div class="math-block">
    `P = (5,7)`
    </div>

<p>
    Let's call the combination of the above elliptic curve and finite field "Curve61".
    What would it look like to plot this curve on a graph? Starting with `x=0`
    and working through each number from 0 to 60, using the math operations we defined above:

<table class="results">
    <tr>
        <td>`x = 0`:</td>
        <td>`y^2 = 0^3 + 9\cdot0 + 1 = 1 % 61 = 1 =>`
        <td>`y = sqrt(1) = text{1 and 60}`</td>
    </tr>
    <tr>
        <td>`x = 1`:</td>
        <td>`y^2 = 1^3 + 9\cdot1 + 1 = 11 % 61 = 11 =>`
        <td>`y = sqrt(11) = text{undefined}`</td>
    </tr>
    <tr>
        <td>`x = 2`:</td>
        <td>`y^2 = 2^3 + 9\cdot2 + 1 = 27 % 61 = 27 =>`
        <td>`y = sqrt(27) = text{24 and 37}`</td>
    </tr>
    <tr>
        <td>`x = 3`:</td>
        <td>`y^2 = 3^3 + 9\cdot3 + 1 = 55 % 61 = 55 =>`
        <td>`y = sqrt(27) = text{undefined}`</td>
    </tr>
    <tr>
        <td>`x = 4`:</td>
        <td>`y^2 = 4^3 + 9\cdot4 + 1 = 101 % 61 = 40 =>`
        <td>`y = sqrt(40) = text{undefined}`</td>
    </tr>
    <tr>
        <td>`x = 5`:</td>
        <td>`y^2 = 5^3 + 9\cdot5 + 1 = 171 % 61 = 49 =>`
        <td>`y = sqrt(49) = text{7 and 54}`</td>
    </tr>
    <tr>
    <td colspan=3>... and so on</td>
</table>

<p>
The resulting graph looks like this:
<figure class="illustration">
    <div class="ill-content">
    <canvas id="canvas-curve61-static" width="500" height="400"></canvas>
    </div>
    <figcaption>An elliptic curve plotted in <span class="fat-fp-61">Fp</span></figcaption>
</figure>

<p>
We can still add points on this curve, using the math of <span class="fat-fp-61">F61</span> and
the rules of point addition: draw lines between two points, find the curve intersection, then negate the point.

<figure class="illustration">
<div class="ill-content">
    <canvas class="animated" id="canvas-addp" width="500" height="400"></canvas>
</div>
    <figcaption>Curve61 point addition</figcaption>
</figure>

<p>This animation shows lines wrapping from 61 to 0 (the modulus effect shown visually),
    sometimes many times. Finding the values algebraically is relatively easy though, just remember
    to use the rules of finite field math:

<p>
    To add two points `P: (x_1, y_1)` and `Q: (x_2, y_2)` to get a third point `R: (x_3, y_3)`:
    <div class="math-block-left ml2">
    `\lambda = \frac{y_2 - y_1}{x_2 - x_1}`
    <br>
    `x_3 = \lambda^2 - x_1 - x_2`
    <br>
    `y_3 = \lambda(x_1 - x_3) - y_1`
    </div>

<p>
    If `P` and `Q` are the same point, then adding them is called "doubling" the point.
    The formula for this is the same, but the slope (lambda) is the curve tangent:

<div class="math-block-left ml2">
`\lambda = \frac{3x_1^2 + 9}{2y_1}`
</div>

<p>
    We can get to arbitrarily large multiples of `P` quickly using a "double-and-add" method:
<ul class="ml2">
    <li>Repeatedly double `P` to get `\{2P, 4P, 8P, 16P, 32P, â€¦\}`</li>
    <li>Add combinations of the above points to get any needed multiple of `P`</li>
</ul>

<figure class="illustration">
    <div class="ill-content">
    <canvas class="animated" id="canvas-double-and-add" width="500" height="400"></canvas>
    </div>
    <figcaption>Double-and-add method for point <span id="dbl-add-np">nP</span></figcaption>
</figure>

</div>

<h2>Key Exchange</h2>
<div>
<p>
    Now we have enough to start doing cryptographic work. We're going to do a key exchange with
    Curve61, much in the same way that TLS 1.3 does a key exchange with Curve25519.

<p>
    Alice and Bob want to start a private conversation. To do this, they're going to agree on a number without
    any eavesdroppers being able to tell what the number is. With an agreed-upon number they can
    derive a key for one of the many fast and secure ciphers (such as AES) and encrypt their conversation.

<p>
The process looks like this:
<ul>
    <li>Alice and Bob agree to use Curve61, described in the section above
    <li>Alice picks a random number `k_a`
    <li>Alice computes the coordinates of `k_(a)P` and sends it to Bob as `A`
    <li>Bob picks a random number `k_b`
    <li>Bob computes the coordinates of `k_(b)P` and sends it to Alice as `B`
    <li>Alice computes the coordinates of `k_(a)B`, which is `k_(a)(k_(b)P)`
    <li>Bob computes the coordinates of `k_(b)A`, which is `k_(b)(k_(a)P)`
</ul>

<p>Because point addition on Curve61 is associative, both `k_b(k_aP)` and `k_a(k_bP)` are the same
point: they're just the base point added to itself `k_a \times k_b` times.  Since they're the
same point, both Alice and Bob have agreed on the same number: the coordinates of `k_ak_bP`.

<p>
Enter numbers for Bob and Alice's private keys below and watch a key exchange occur:

<form class="row row-cols-sm-auto g-3 align-items-center" onsubmit="return false">
    <div class="col-12">
    <div class="input-group input-group-sm">
    <label for="alice-key" class="col-form-label col-form-label-sm">k<sub>a</sub>&nbsp;</label>
    <input type="text" class="form-control form-control-sm" id="alice-key"
           required pattern="[1-9][0-9]*" placeholder="Alice's key">
    </div>
    </div>

    <div class="col-12">
    <div class="input-group input-group-sm">
    <label for="bob-key" class="col-form-label col-form-label-sm">k<sub>b</sub>&nbsp;</label>
    <input type="text" class="form-control form-control-sm" id="bob-key"
           required pattern="[1-9][0-9]*" placeholder="Bob's key">
    </div>
    </div>

    <div class="col-12">
    <button type="submit" class="btn btn-primary btn-sm" id="go-exchange" disabled>Go</button>
    </div>
    <div class="col-12">
    <button type="submit" class="btn btn-primary btn-sm" id="rand-exchange">Random</button>
    </div>
</form>

<figure class="illustration">
    <div class="ill-content">
    <div id="alice-desc">Alice:</div>
    <canvas class="animated no-click" id="canvas-alice" width="500" height="300" data-visible=always></canvas>
    <div id="bob-desc">Bob:</div>
    <canvas class="animated no-click" id="canvas-bob" width="500" height="300" data-visible=always></canvas>
    </div>
</figure>
</div>

<h2>Back to the real curve</h2>

<p>
We've played around with a toy curve, and you've seen what it means to add points or perform a key exchange.
But how does this compare to real curves used in real cryptography?

<p>
The most common curve used for key exchange is Curve25519. That curve has a simple equation:
<div class="math-block">
`y^2 = x^3 + 486662x^2 + x`
</div>

<p>
    Where our toy curve used <span class="fat-fp-61">F61</span>, a field with 61 numbers in it,
    Curve25519 uses `\mathbb{F}_(2^255\text{-}19)`. The prime number used for that field,
    `2^255-19`, is a 77-digit number. Other than the size, the field looks the same as the one
    we've been using:
<div class="math-block">
`\mathbb{F}_(2^255\text{-}19) = {0, 1, 2, â€¦, 2^255-21, 2^255-20}`
</div>

<p>
    Where our toy curve used a base point that can only be added to itself 73 times before repeating,
    `\mathbb{F}_(2^255\text{-}19)` uses a base point that can be added to itself over
    `2^252` times before repeating.

<p>
    When peers use Curve25519 to perform key exchange, they select a random 256-bit number (though 5 of those
    bits are then overridden; see <a href="https://x25519.ulfheim.net">my X25519 site</a> for more details). That's
    `2^251` possible point multiplications for an attacker to guess at, which is a 76-digit number.

<p>
    Much like the toy curve we've been using, we can add and double points on Curve25519. Using that we
    can perform a key exchange in the same way as explained above. Because the curve equation is
    different the formula for adding and doubling is also different, see
    <a href="https://en.wikipedia.org/wiki/Montgomery_curve">Wikipedia</a> for details.

<p>
    For more information on Curve25519, including the reason for the choice of curve equation, the prime
    number used for <span class="fat-fp">Fp</span>, and the exact details of key exchange I can recommend
    <a href="https://cr.yp.to/ecdh/curve25519-20060209.pdf">the author's paper</a> and also
    <a href="https://martin.kleppmann.com/papers/curve25519.pdf">this technical analysis</a>.
    Most of these details are streamlining of the concepts listed on this page to keep the exchange
    mechanism secure and performant, and should not fundamentally conflict with what's explained here.

<h2>Epilogue</h2>

<p>
    The code for this project can be found
    <a href="https://github.com/syncsynchalt/viz-curves">on GitHub</a>.

<p>
    I hope you found this page useful or at least interesting! If so let me know via Twitter
    <a href="https://twitter.com/xargsnotbombs">@XargsNotBombs</a>.

</div> <!-- container -->

<script type="module" src="fixups.js"></script>
</body>
</html>
